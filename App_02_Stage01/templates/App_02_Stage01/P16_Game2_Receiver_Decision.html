{% extends "otree/Page.html" %}
{% load staticfiles %}

{% block styles %}
  <link rel="stylesheet" href="{% static 'common.css' %}">
  <style>
    .status-message { font-size: 1.2em; font-weight: bold; color: #3B95C4; margin: 24px 0; text-align: center; }
    .sim-card {
      background: #fff;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 24px;
      margin-bottom: 24px;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .result-highlight {
        color: #3B95C4;
        font-weight: bold;
        font-size: 1.4em;
    }
    .profile-row {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 32px;
        margin-bottom: 24px;
    }
    .arrow {
        font-size: 2em;
        color: #aaa;
    }
    .btn-disabled-custom {
      background-color: #ccc !important; cursor: not-allowed; border-color: #bbb !important;
    }
  </style>
{% endblock %}

{% block title %}お返しゲーム (1/2){% endblock %}

{% block content %}
  <div class="experiment-container">
    <div class="content-area">
      <h2>お返しゲーム：相手への返礼</h2>
      
      <div class="profile-row">
        <div class="profile-card">
          <div class="icon {{ bot.icon_class }}"><svg><use xlink:href="#icon-person"></use></svg></div>
          <span class="name">{{ bot.name }}</span>
        </div>
        <div class="arrow">→</div>
        <div class="profile-card">
          <div class="icon icon-user"><svg><use xlink:href="#icon-person"></use></svg></div>
          <span class="name">あなた</span>
        </div>
      </div>

      <div class="status-message">
        {{ bot.name }}から贈り物が届きました！
      </div>
      
      <div class="sim-card">
        <p>
          {{ bot.name }}の贈り物: <strong>{{ bot.gift_amount }} pt / {{ initial_endowment }} pt</strong>
          <br>↓ (× {{ multiplier }})<br>
          あなたに届いた額: <span class="result-highlight">{{ received_amount }} pt</span>
        </p>
        <hr style="margin: 16px 0; border:0; border-top:1px dashed #ccc;">
        
        <div style="background:#f9f9f9; padding:16px; border-radius:8px; border:1px solid #eee; text-align:left;">
          <label style="font-weight:bold; color:#d9534f;">
            お返し額を決めてください
          </label>
          <div class="slider-container" style="display:flex; align-items:center; gap:12px; margin-top:12px;">
            <span>0</span>
            <input type="range" id="return-slider" name="g2_return" min="0" max="{{ received_amount }}" value="0" style="flex:1;">
            <span style="font-weight:bold; width:60px; text-align:right; color:#3B95C4;" id="return-display">0</span> pt
          </div>
          <p style="font-size:0.9em; color:#666; margin-top:8px;">
            ※ スライダーを動かして決定してください。<br>
            ※ <strong>30秒間</strong> は考えを整理する時間として、決定ボタンが押せません。
          </p>
        </div>
        
        <p style="margin-top:16px;">
           あなたの最終利得: <span class="result-highlight" id="final-gain">--</span> pt
        </p>
      </div>
      
      <div class="navigation-footer">
        <p id="msg-wait-user" style="font-weight:bold; color:#d9534f; margin-bottom:8px;">
          熟考時間：残り <span id="timer-user">30</span> 秒
        </p>
        <button class="btn btn-primary btn-disabled-custom" id="btn-submit" disabled>
          決定して次へ
        </button>
      </div>

    </div>
  </div>
  
  <svg class="icon-svg" style="display:none;">
    <symbol id="icon-person" viewBox="0 0 24 24">
      <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
    </symbol>
  </svg>

{% endblock %}

{% block scripts %}
  <script>
    const BOT_GIFT = {{ bot.gift_amount }};
    const MULTIPLIER = {{ multiplier }};
    const RECEIVED = {{ received_amount }};
    const CURRENT_HOLDING = RECEIVED;
    
    const THINK_TIME = 30;

    document.addEventListener("DOMContentLoaded", function() {
      const timerUser = document.getElementById('timer-user');
      const msgWaitUser = document.getElementById('msg-wait-user');
      const btnSubmit = document.getElementById('btn-submit');
      
      const slider = document.getElementById('return-slider');
      const display = document.getElementById('return-display');
      const gainDisplay = document.getElementById('final-gain');

      // 利得計算
      function updateCalc() {
        const val = parseInt(slider.value);
        display.textContent = val;
        gainDisplay.textContent = CURRENT_HOLDING - val;
      }
      slider.addEventListener('input', updateCalc);
      updateCalc(); // 初期実行

      // ユーザー熟考タイマー
      let timeUser = THINK_TIME;
      const intervalUser = setInterval(() => {
        timeUser--;
        timerUser.textContent = timeUser;
        if (timeUser <= 0) {
          clearInterval(intervalUser);
          enableSubmit();
        }
      }, 1000);

      function enableSubmit() {
        btnSubmit.disabled = false;
        btnSubmit.classList.remove('btn-disabled-custom');
        msgWaitUser.style.display = 'none';
      }
    });
  </script>
{% endblock %}