{% extends "otree/Page.html" %}
{% load staticfiles %}

{% block styles %}
  <link rel="stylesheet" href="{% static 'common.css' %}">
  <style>
    /* 練習セクション間のマージン */
    .practice-section {
      margin-top: 32px;
      padding-top: 24px;
      border-top: 2px dashed #E0E0E0;
    }
    .practice-section:first-child {
      margin-top: 0;
      padding-top: 0;
      border-top: none;
    }
    
    /* 結果表示エリア */
    .sim-result-area {
      display: none; /* JSで表示を制御 */
      margin-top: 16px;
      padding: 16px;
      background-color: #F9F9F9;
      border: 1px solid #E0E0E0;
      border-radius: 8px;
    }
    .sim-result-area p {
      margin: 8px 0;
      font-size: 1.0em;
    }
    .sim-result-area p.final-gain {
      font-size: 1.2em;
      font-weight: bold;
    }

    /* Bot挙動決定ボタンのコンテナ */
    .bot-decision-container {
      text-align: center;
      padding: 24px 0;
    }

    /* Bot挙動表示エリア (common.cssのgossip-illustratorを流用) */
    .bot-behavior-display {
      display: none; /* JSで表示を制御 */
      justify-content: center;
      align-items: center;
      gap: 16px;
      margin: 24px 0;
      background-color: #F9F9F9;
      border: 1px solid #E0E0E0;
      padding: 16px;
      border-radius: 8px;
    }

    /* シミュレーション入力欄 (スライダーなど) */
    .simulation-input-area {
      display: none; /* JSで表示を制御 */
    }
  </style>
{% endblock %}

{% block title %}
  タスク２：お返しゲーム 練習
{% endblock %}

{% block content %}
  <svg class="icon-svg">
    <symbol id="icon-person" viewBox="0 0 24 24">
      <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
    </symbol>
  </svg>

  <div class="experiment-container">

    <div class="progress-tabs">
      <div class="tab-button active">実験の進捗</div>
    </div>

    <div class="progress-content">
      <div class="progress-steps active" id="steps-role2">
        <div class="step completed"><div class="step-number">1</div>同意取得</div>
        <div class="step completed"><div class="step-number">2</div>実験概要説明</div>
        <div class="step completed"><div class="step-number">3</div>お返しゲーム説明</div>
        <div class="step current"><div class="step-number">4</div>タスク２説明</div>
        <div class="step"><div class="step-number">5</div>アンケート</div>
        <div class="step"><div class="step-number">6</div>報酬の確認</div>
      </div>
    </div>
    
    <div class="experiment-header">
      
      <div class="room-tabs">
        <div>作業ルーム1</div>
        <div>作業ルーム2</div>
        <div class="active">全体ルーム</div> </div>
      
      <div class="header-right-panel">
        <button type="button" class="rule-check-button" id="open-rules-modal">
          ルールを確認する
        </button>
        <div class="user-profile">
          <div class="icon icon-user">
            <svg><use xlink:href="#icon-person"></use></svg>
          </div>
          <span class="name">あなた</span>
        </div>
      </div>
    </div>    

    <div class="content-area">
      <h2 id="page-title">お返しゲーム 練習</h2>
      <p>
        「お返しゲーム」の練習です。<br>
        「贈り物を渡す側」と「返礼する側」の両方を、下のシミュレーターで自由に練習してください。
      </p>
      
      <div class="practice-section">
        <h3>練習1：あなたが「贈り物を渡す側」</h3>
        <p>
            あなたは 1000 pt を持っています。練習相手にいくら贈りますか？<br>
            あなたが贈った額は {{ Constants.MULTIPLIER }} 倍になって相手に届きます。
        </p>
        
        <div class="rule-box">
            
          <div class="bot-decision-container" id="giver-bot-decision-area">
            <p>まず、練習相手の「返礼ルール」をランダムに決めます。</p>
            <button type="button" class="btn btn-primary" id="determine-giver-bot-btn">
              返礼ルールを決める
            </button>
          </div>

          <div class="bot-behavior-display" id="giver-bot-behavior-display">
            <div class="profile-card" style="width: 100px; padding: 12px;">
              <div class="icon icon-practice-receiver" style="width: 40px; height: 40px;"><svg><use xlink:href="#icon-person"></use></svg></div>
              <span class="name" style="font-size: 0.9em;">練習相手</span>
            </div>
            <div class="speech-bubble" id="giver-bot-speech-bubble">
              「届いた額の xx% を返礼します」
            </div>
          </div>

          <div class="simulation-input-area" id="giver-simulation-area">
            <div class="slider-container">
              <span>0 pt</span>
              <input type="range" id="invest-slider" min="0" max="{{ Constants.INVESTMENT_MAX }}" value="50" style="flex: 1;">
              <span>{{ Constants.INVESTMENT_MAX }} pt</span>
              <span class="slider-value" id="invest-value-display" style="width: 50px; text-align: right;">50</span> pt
            </div>
            <div style="text-align: center; margin-top: 16px;">
              <button type="button" class="btn btn-primary" id="calculate-giver-btn">
                決定（結果をシミュレーション）
              </button>
            </div>
          </div>
          
          <div class="sim-result-area" id="giver-result-area">
            <h4>計算結果 (贈る側)</h4>
            <p>1. あなたは <span class="calc-value" data-id="investment">0</span> pt を贈りました。（あなたの取り分: <span class="calc-value" data-id="your_keep">0</span> pt）</p>
            <p>2. 相手には <span class="calc-value" data-id="received_by_bot">0</span> pt が届きました。</p>
            <p>3. 練習相手は <span class="calc-value" data-id="bot_return">0</span> pt をあなたに返礼しました。</p>
            <p class="final-gain">
              あなたの最終利得: (取り分 <span data-id="your_keep">0</span>) + (返礼 <span data-id="bot_return">0</span>) = <span class="calc-value" data-id="final_payoff">0</span> pt
            </p>
          </div>
        </div>
      </div>

      <div class="practice-section">
        <h3>練習2：あなたが「返礼する側」</h3>
        <p>
          練習相手があなたに贈る額をランダムに決めます。<br>
          練習相手から贈られた額は {{ Constants.MULTIPLIER }} 倍になってあなたに届きます。
        </p>

        <div class="rule-box">
          <div class="bot-decision-container" id="receiver-bot-decision-area">
            <p>まず、練習相手の「贈与額」をランダムに決めます。</p>
            <button type="button" class="btn btn-primary" id="determine-receiver-bot-btn">
              贈与額を決める
            </button>
          </div>

          <div class="bot-behavior-display" id="receiver-bot-behavior-display">
            <div class="profile-card" style="width: 100px; padding: 12px;">
              <div class="icon icon-practice-receiver" style="width: 40px; height: 40px;"><svg><use xlink:href="#icon-person"></use></svg></div>
              <span class="name" style="font-size: 0.9em;">練習相手</span>
            </div>
            <div class="speech-bubble" id="receiver-bot-speech-bubble">
              「あなたに xx pt 贈ります」
            </div>
          </div>
          
          <div class="simulation-input-area" id="receiver-simulation-area">
            <p style="text-align: center; font-weight: bold;">
              あなたには <span class="calc-value" id="received-by-you-display">0</span> pt が届きました。<br>
              相手にいくら返礼しますか？
            </p>
            <div class="slider-container">
              <span>0 pt</span>
              <input type="range" id="return-slider" min="0" max="0" value="0" style="flex: 1;">
              <span class="slider-value" id="return-value-display" style="width: 50px; text-align: right;">0</span> pt
            </div>
            <div style="text-align: center; margin-top: 16px;">
              <button type="button" class="btn btn-primary" id="calculate-receiver-btn">
                決定（結果をシミュレーション）
              </button>
            </div>
          </div>
          
          <div class="sim-result-area" id="receiver-result-area">
            <h4>計算結果 (返礼する側)</h4>
            <p>1. あなたには <span class="calc-value" data-id="received_by_you">0</span> pt が届きました。</p>
            <p>2. あなたは <span class="calc-value" data-id="return_amount">0</span> pt を返礼しました。</p>
            <p class="final-gain">
              あなたの最終利得: (届いた額 <span data-id="received_by_you">0</span>) - (返礼 <span data-id="return_amount">0</span>) = <span class="calc-value" data-id="final_payoff">0</span> pt
            </p>
          </div>
        </div>
      </div>

    </div>
    
    <div class="navigation-footer">
      {% next_button %}
    </div>
  </div>
{% endblock %}

{% block scripts %}
  <script src="{% static 'common.js' %}"></script>
  <script>
    (function() {
      // --- スライダーと数値表示の連動 ---
      const investSlider = document.getElementById('invest-slider');
      const investDisplay = document.getElementById('invest-value-display');
      const returnSlider = document.getElementById('return-slider');
      const returnDisplay = document.getElementById('return-value-display');

      investSlider.addEventListener('input', () => {
        investDisplay.textContent = investSlider.value;
      });
      returnSlider.addEventListener('input', () => {
        returnDisplay.textContent = returnSlider.value;
      });

      // --- 練習1 (贈る側) ---
      const determineGiverBtn = document.getElementById('determine-giver-bot-btn');
      const giverBehaviorDisplay = document.getElementById('giver-bot-behavior-display');
      const giverSpeechBubble = document.getElementById('giver-bot-speech-bubble');
      const giverSimulationArea = document.getElementById('giver-simulation-area');
      const calculateGiverBtn = document.getElementById('calculate-giver-btn');
      const giverResultArea = document.getElementById('giver-result-area');
      
      // 1-1. Botの返礼率を決めるボタン
      determineGiverBtn.addEventListener('click', () => {
        liveSend_determine_bot_giver({});
        // ボタンを無効化（リロードするまで再決定不可）
        determineGiverBtn.disabled = true;
        determineGiverBtn.textContent = 'ルール決定中...';
      });

      // 1-2. 贈与シミュレーションボタン
      calculateGiverBtn.addEventListener('click', () => {
        const investment = parseInt(investSlider.value);
        liveSend_calculate_giver({ investment: investment });
      });

      // --- 練習2 (返礼する側) ---
      const determineReceiverBtn = document.getElementById('determine-receiver-bot-btn');
      const receiverBehaviorDisplay = document.getElementById('receiver-bot-behavior-display');
      const receiverSpeechBubble = document.getElementById('receiver-bot-speech-bubble');
      const receiverSimulationArea = document.getElementById('receiver-simulation-area');
      const calculateReceiverBtn = document.getElementById('calculate-receiver-btn');
      const receiverResultArea = document.getElementById('receiver-result-area');
      
      // 2-1. Botの贈与額を決めるボタン
      determineReceiverBtn.addEventListener('click', () => {
        liveSend_determine_bot_receiver({});
        determineReceiverBtn.disabled = true;
        determineReceiverBtn.textContent = '贈与額を決定中...';
      });

      // 2-2. 返礼シミュレーションボタン
      calculateReceiverBtn.addEventListener('click', () => {
        const returnAmount = parseInt(returnSlider.value);
        liveSend_calculate_receiver({ return_amount: returnAmount });
      });

      // --- Pythonからの計算結果を受け取る共通の関数 ---
      function liveRecv(data) {
        console.log("Pythonから結果受信:", data);
        
        if (data.type === 'bot_giver_determined') {
          // 練習1: Botの返礼率が決定した
          giverSpeechBubble.textContent = `「届いた額の ${data.rate_percent}% を返礼します」`;
          giverBehaviorDisplay.style.display = 'flex';
          giverSimulationArea.style.display = 'block';
          determineGiverBtn.textContent = `ルール決定 ( ${data.rate_percent}% )`;

        } else if (data.type === 'giver_result') {
          // 練習1: シミュレーション結果
          updateResultArea(giverResultArea, data);
          giverResultArea.style.display = 'block';
        
        } else if (data.type === 'bot_receiver_determined') {
          // 練習2: Botの贈与額が決定した
          receiverSpeechBubble.textContent = `「あなたに ${data.gift_amount} pt 贈ります」`;
          document.getElementById('received-by-you-display').textContent = data.received_amount;
          
          // 返礼スライダーの最大値と初期値を設定
          returnSlider.max = data.received_amount;
          const initialReturn = Math.floor(data.received_amount / 2);
          returnSlider.value = initialReturn;
          returnDisplay.textContent = initialReturn;

          receiverBehaviorDisplay.style.display = 'flex';
          receiverSimulationArea.style.display = 'block';
          determineReceiverBtn.textContent = `贈与額決定 ( ${data.gift_amount} pt )`;
          
        } else if (data.type === 'receiver_result') {
          // 練習2: シミュレーション結果
          updateResultArea(receiverResultArea, data);
          receiverResultArea.style.display = 'block';
        }
      }
      
      // 結果エリアのHTMLを更新するヘルパー関数
      function updateResultArea(areaElement, data) {
        areaElement.querySelectorAll('[data-id]').forEach(span => {
          const key = span.dataset.id;
          if (data.hasOwnProperty(key)) {
            span.textContent = data[key];
          }
        });
      }
      
      // liveRecv関数をoTreeに登録
      window.liveRecv = liveRecv;

    })();
  </script>
{% endblock %}