{% extends "otree/Page.html" %}
{% load staticfiles %}

{# --- 共通CSS/JSの読み込み --- #}
{% block styles %}
  <link rel="stylesheet" href="{% static 'common.css' %}">
  
  <style>
    .info-summary-container {
      display: flex; flex-direction: column; gap: 16px;
    }
    .info-summary-container .member-profile-container { margin: 0; }
    .info-summary-container .gossip-illustrator {
      margin: 0; background-color: #F9F9F9; border-radius: 8px; padding: 16px;
    }
    .dropzone-container {
      display: flex; justify-content: space-around; gap: 12px; margin-bottom: 24px;
    }
    .dropzone {
      flex: 1; height: 180px; display: flex; flex-direction: column;
      justify-content: flex-start; align-items: center; padding: 12px;
    }
    .dropzone .rank-label {
      font-size: 1.1em; font-weight: bold; color: #000000; margin-bottom: 12px;
    }
    .draggable-container {
      display: flex; justify-content: center; gap: 16px; margin-top: 16px;
      padding: 16px; border: 1px solid #E0E0E0; border-radius: 8px;
      background-color: #F9F9F9; min-height: 180px;
    }
    .decision-block {
      display: flex; align-items: center; gap: 16px; margin-bottom: 16px;
      padding-bottom: 16px; border-bottom: 1px solid #F0F0F0;
    }
    .decision-block:last-child { border-bottom: none; margin-bottom: 0; }
    .decision-block .player-label { flex-basis: 120px; text-align: center; font-weight: bold; }
    .decision-block .slider-area { flex: 1; }
    .decision-block .slider-container { padding: 0 8px; }
    .distribute-display-simple {
      font-size: 0.9em; color: #454545; text-align: center; margin-top: 8px;
    }
    #validation-error-message {
      color: #D9534F; font-weight: bold; text-align: center;
      margin-top: 16px; display: none;
    }
  </style>
{% endblock %}

{# --- ページのタイトル --- #}
{% block title %}
  タスク２：意思決定
{% endblock %}

{# --- ページのメインコンテンツ --- #}
{% block content %}

  <svg class="icon-svg">
    <symbol id="icon-person" viewBox="0 0 24 24">
      <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
    </symbol>
  </svg>

  <div class="experiment-container">
    
    <div class="progress-tabs">
      <div class="tab-button active" id="tab-role2">あなたの進捗</div>
      <div class="tab-button" id="tab-role1">他メンバーの進捗</div>
    </div>
    
    <div class="progress-content">
      <div class="progress-steps active" id="steps-role2">
        <div class="step completed"><div class="step-number">1</div>同意取得</div>
        <div class="step completed"><div class="step-number">2</div>実験概要説明</div>
        <div class="step completed"><div class="step-number">3</div>タスク１説明</div>
        <div class="step current"><div class="step-number">4</div>タスク２説明</div>
        <div class="step"><div class="step-number">5</div>アンケート</div>
        <div class="step"><div class="step-number">6</div>報酬の確認</div>
      </div>
      <div class="progress-steps" id="steps-role1">
        <div class="step completed"><div class="step-number">1</div>同意取得</div>
        <div class="step completed"><div class="step-number">2</div>実験概要説明</div>
        <div class="step completed"><div class="step-number">3</div>タスク１説明</div>
        <div class="step current"><div class="step-number">4</div>タスク１実施</div>
        <div class="step"><div class="step-number">5</div>アンケート</div>
        <div class="step"><div class="step-number">6</div>報酬の確認</div>
      </div>
    </div>
    
    <div class="experiment-header">
      <div class="room-tabs">
        <div>作業ルーム1</div>
        <div class="active">作業ルーム2</div>
        <div>全体ルーム</div> 
      </div>
      <div class="header-right-panel">
        <button type="button" class="rule-check-button" id="open-rules-modal">
          ルールを確認する
        </button>
        <div class="user-profile">
          <div class="icon icon-user">
            <svg><use xlink:href="#icon-person"></use></svg>
          </div>
          <span class="name">あなた</span>
        </div>
      </div>
    </div>
    
    <div class="content-area">
      <h2 id="page-title">タスク２：意思決定</h2>
      <p>
        これまでの情報を参考に、4名の「パートナーの優先順位」と、4名それぞれへの「贈り物の額」を決定してください。<br>
        あなたの決定に基づき、報酬が計算されます。
      </p>

      <div class="rule-box" id="info-summary-section">
        <h3>【情報のまとめ】</h3>
        <div class="info-summary-container">
          <div class="member-profile-container">
            <div class="profile-card" id="player-A">
              <div class="icon icon-a"><svg><use xlink:href="#icon-person"></use></svg></div>
              <span class="name">レッドさん</span>
              <span class="reputation-display" style="font-weight: bold; display: block; margin-top: 8px; color: #3B95C4;">
                平均 {{ rep_A }} pt
              </span>
            </div>
            <div class="profile-card" id="player-B">
              <div class="icon icon-b"><svg><use xlink:href="#icon-person"></use></svg></div>
              <span class="name">シアンさん</span>
              <span class="reputation-display" style="font-weight: bold; display: block; margin-top: 8px; color: #D9534F;">
                平均 {{ rep_B }} pt
              </span>
            </div>
            <div class="profile-card" id="player-C">
              <div class="icon icon-c"><svg><use xlink:href="#icon-person"></use></svg></div>
              <span class="name">グリーンさん</span>
              <span class="reputation-display" style="font-weight: bold; display: block; margin-top: 8px;">？？？</span>
            </div>
            <div class="profile-card" id="player-X">
              <div class="icon icon-x"><svg><use xlink:href="#icon-person"></use></svg></div>
              <span class="name">オレンジさん</span>
              <span class="reputation-display" style="font-weight: bold; display: block; margin-top: 8px;">？？？</span>
            </div>
          </div>

          <div class="gossip-illustrator">
            <div class="profile-card" id="gossip-sender-card">
              <div class="icon {{ gossip_sender_icon_class }}"><svg><use xlink:href="#icon-person"></use></svg></div>
              <span class="name" id="gossip-sender-name">{{ gossip_sender_name }}</span>
            </div>
            <div class="speech-bubble" id="gossip-content">
              「{{ gossip_content_text }}」
            </div>
          </div>
        </div>
      </div>

      <div class="rule-box" id="ranking-section">
        <h3>【1. パートナーの優先順位】</h3>
        <p style="text-align: center;">下の4名のアイコンを、上の1位〜4位の枠にドラッグ＆ドロップで配置してください。</p>
        <!-- ドロップ先 -->
        <div class="dropzone-container">
          <div class="dropzone" data-rank="1"><span class="rank-label">1位</span></div>
          <div class="dropzone" data-rank="2"><span class="rank-label">2位</span></div>
          <div class="dropzone" data-rank="3"><span class="rank-label">3位</span></div>
          <div class="dropzone" data-rank="4"><span class="rank-label">4位</span></div>
        </div>
        <!-- ドラッグ元 -->
        <div class="draggable-container" id="draggable-container">
          <div class="profile-card draggable" id="drag-A" data-player-id="A" draggable="true">
            <div class="icon icon-a"><svg><use xlink:href="#icon-person"></use></svg></div>
            <span class="name">レッドさん</span>
          </div>
          <div class="profile-card draggable" id="drag-B" data-player-id="B" draggable="true">
            <div class="icon icon-b"><svg><use xlink:href="#icon-person"></use></svg></div>
            <span class="name">シアンさん</span>
          </div>
          <div class="profile-card draggable" id="drag-C" data-player-id="C" draggable="true">
            <div class="icon icon-c"><svg><use xlink:href="#icon-person"></use></svg></div>
            <span class="name">グリーンさん</span>
          </div>
          <div class="profile-card draggable" id="drag-X" data-player-id="X" draggable="true">
            <div class="icon icon-x"><svg><use xlink:href="#icon-person"></use></svg></div>
            <span class="name">オレンジさん</span>
          </div>
        </div>
        <div id="validation-error-message">
          すべてのパートナーを1位〜4位の枠に配置してください。
        </div>
      </div>

      <div class="rule-box" id="investment-section">
        <h3>【2. 贈り物の額（信頼投資額）】</h3>
        <p style="text-align: center;">4名それぞれに対して、お返しゲームで贈る額（0〜100pt）をスライダーで決定してください。</p>
        
        <div class="decision-block">
          <div class="player-label">レッドさん</div>
          <div class="slider-area">
            <div class="slider-container" id="slider-A-container">
              <input type="range" class="invest-slider" id="invest-A" name="investment_A" min="0" max="100" value="50">
              <span class="slider-value">50</span> pt
            </div>
            {{ formfield_errors 'investment_A' }}
            <div class="distribute-display-simple" id="dist-A-display">
              あなたの取り分: 50 pt / 相手に届く額: 150 pt
            </div>
          </div>
        </div>

        <div class="decision-block">
          <div class="player-label">シアンさん</div>
          <div class="slider-area">
            <div class="slider-container" id="slider-B-container">
              <input type="range" class="invest-slider" id="invest-B" name="investment_B" min="0" max="100" value="50">
              <span class="slider-value">50</span> pt
            </div>
            {{ formfield_errors 'investment_B' }}
            <div class="distribute-display-simple" id="dist-B-display">
              あなたの取り分: 50 pt / 相手に届く額: 150 pt
            </div>
          </div>
        </div>
        
        <div class="decision-block">
          <div class="player-label">グリーンさん</div>
          <div class="slider-area">
            <div class="slider-container" id="slider-C-container">
              <input type="range" class="invest-slider" id="invest-C" name="investment_C" min="0" max="100" value="50">
              <span class="slider-value">50</span> pt
            </div>
            {{ formfield_errors 'investment_C' }}
            <div class="distribute-display-simple" id="dist-C-display">
              あなたの取り分: 50 pt / 相手に届く額: 150 pt
            </div>
          </div>
        </div>
        
        <div class="decision-block">
          <div class="player-label">オレンジさん</div>
          <div class="slider-area">
            <div class="slider-container" id="slider-X-container">
              <input type="range" class="invest-slider" id="invest-X" name="investment_X" min="0" max="100" value="50">
              <span class="slider-value">50</span> pt
            </div>
            {{ formfield_errors 'investment_X' }}
            <div class="distribute-display-simple" id="dist-X-display">
              あなたの取り分: 50 pt / 相手に届く額: 150 pt
            </div>
          </div>
        </div>

        <input type="hidden" name="rank_A" id="id_rank_A">
        <input type="hidden" name="rank_B" id="id_rank_B">
        <input type="hidden" name="rank_C" id="id_rank_C">
        <input type="hidden" name="rank_X" id="id_rank_X">
        
      </div>
    </div>
    
    <div class="navigation-footer">
      <button type="submit" class="btn btn-primary" id="next-button" disabled>
        意思決定を確定する
      </button>
    </div>

  </div>
  
  <div class="experiment-footer">
    <a id="quit-link">実験への参加を中断する</a>
  </div>

  <div class="modal-overlay" id="rules-modal">
    <div class="modal-content">
      <div class="modal-header">
        <span>ルール確認</span>
        <button class="close-button" id="close-rules-modal">&times;</button>
      </div>
      <div class="modal-body" id="rules-modal-body">
        <p>（P9時点でのルールをここに挿入できます）</p>
      </div>
    </div>
  </div>

{% endblock %}


{# --- ページ固有スクリプト --- #}
{% block scripts %}

  <script src="{% static 'common.js' %}"></script>

  <script>
    (function() {
      // --- 共通コンポーネントの初期化 (P19.html と同じ) ---
      
      // 1. D&D (セクション2)
      const dndController = window.DragDropController;
      dndController.init(
        '.draggable', 
        '.dropzone', 
        '#draggable-container'
      );
      
      // 2. 贈与額スライダー (セクション3) (P19.html と同じ)
      const sliders = document.querySelectorAll('.invest-slider');
      sliders.forEach(slider => {
        const container = slider.closest('.slider-area');
        const valueDisplay = container.querySelector('.slider-value');
        const distDisplay = container.querySelector('.distribute-display-simple');
        
        function updateDisplay(value, valueEl, distEl) {
          const invest = parseInt(value);
          const gain = 100 - invest;
          // ★ 計画書  に従い、本番は「2倍」
          const received = invest * 2; 
          valueEl.textContent = invest;
          distEl.textContent = `あなたの取り分: ${gain} pt / 相手に届く額: ${received} pt`;
        }
        
        updateDisplay(slider.value, valueDisplay, distDisplay); 
        slider.addEventListener('input', () => {
          updateDisplay(slider.value, valueDisplay, distDisplay);
        });
      });

      // --- バリデーション＆ナビゲーション ---
      const nextButton = document.getElementById('next-button');
      const errorMessage = document.getElementById('validation-error-message');
      
      function validateDecisions() {
        // D&D (セクション2) が完了しているかチェック
        const dndState = dndController.getState();
        if (dndState.isComplete()) {
          nextButton.disabled = false;
          errorMessage.style.display = 'none';
          return true; // ★ バリデーションOK
        } else {
          nextButton.disabled = true;
          errorMessage.style.display = 'block';
          return false; // ★ バリデーションNG
        }
      }
      
      // D&D操作のたびにバリデーションを実行
      document.addEventListener('drop', validateDecisions);
      
      // ★★★ 修正点(2) ★★★
      // 元のP19.html の「ボタンクリック時」や「グローバル」にあった
      // 隠しフィールド更新ロジックを、
      // フォームの「送信(submit)直前」に実行するように変更します。

      // oTreeのフォーム（IDは常に 'form'）を取得
      const form = document.getElementById('form');
      
      form.addEventListener('submit', function(event) {
        // 1. 送信直前に、最終バリデーション
        if (!validateDecisions()) {
          event.preventDefault(); // D&Dが未完了なら送信を中止
          return;
        }
        
        // 2. D&Dの結果を取得
        const dndState = dndController.getState();
        const ranks = dndState.ranks; // { "1": "A", "2": "C", ... }

        // 3. 逆引きマップを作成 { "A": 1, "C": 2, ... }
        let rankMap = {};
        for (const rank in ranks) {
          const playerId = ranks[rank]; // "A", "B", "C", "X"
          rankMap[playerId] = parseInt(rank);
        }

        // 4. 隠しフィールド (name="rank_A" など) に値をセット
        document.getElementById('id_rank_A').value = rankMap['A'] || 0;
        document.getElementById('id_rank_B').value = rankMap['B'] || 0;
        document.getElementById('id_rank_C').value = rankMap['C'] || 0;
        document.getElementById('id_rank_X').value = rankMap['X'] || 0;
        
        // 5. スライダーの値 (name="investment_A" など) は
        //    input要素なので、何もしなくても自動で送信されます。
      });

    })();
  </script>

{% endblock %}